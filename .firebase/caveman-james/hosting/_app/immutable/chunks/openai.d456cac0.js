import{d as x}from"./_commonjs-dynamic-modules.5fcb8f34.js";import{R as B,d as D,g as d,i as S,C as q,e as V,h as Y}from"./NavBar.74969093.js";import{f as R,g as Z}from"./azure.11841502.js";import{g as J,C as W,z as F,h as M}from"./question.3ffbfd3a.js";import{p as H}from"./prompt-layer.00daf386.js";class $ extends J{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]})}async generate(e,t,r){var p;let n;Array.isArray(t)?n={stop:t}:t!=null&&t.timeout&&!t.signal?n={...t,signal:AbortSignal.timeout(t.timeout)}:n=t??{};const i={tags:n.tags,metadata:n.metadata,callbacks:n.callbacks??r};delete n.tags,delete n.metadata,delete n.callbacks;const c=await W.configure(i.callbacks,this.callbacks,i.tags,this.tags,i.metadata,this.metadata,{verbose:this.verbose}),_={options:n,invocation_params:this==null?void 0:this.invocationParams(n)},s=await(c==null?void 0:c.handleChatModelStart(this.toJSON(),e,void 0,void 0,_)),I=await Promise.allSettled(e.map((l,m)=>this._generate(l,{...n,promptIndex:m},s==null?void 0:s[m]))),a=[],o=[];await Promise.all(I.map(async(l,m)=>{var A,P;if(l.status==="fulfilled"){const b=l.value;return a[m]=b.generations,o[m]=b.llmOutput,(A=s==null?void 0:s[m])==null?void 0:A.handleLLMEnd({generations:[b.generations],llmOutput:b.llmOutput})}else return await((P=s==null?void 0:s[m])==null?void 0:P.handleLLMError(l.reason)),Promise.reject(l.reason)}));const y={generations:a,llmOutput:o.length?(p=this._combineLLMOutput)==null?void 0:p.call(this,...o):void 0};return Object.defineProperty(y,B,{value:s?{runIds:s==null?void 0:s.map(l=>l.runId)}:void 0,configurable:!0}),y}invocationParams(e){return{}}_modelType(){return"base_chat_model"}async generatePrompt(e,t,r){const n=e.map(i=>i.toChatMessages());return this.generate(n,t,r)}async call(e,t,r){return(await this.generate([e],t,r)).generations[0][0].message}async callPrompt(e,t,r){const n=e.toChatMessages();return this.call(n,t,r)}async predictMessages(e,t,r){return this.call(e,t,r)}async predict(e,t,r){const n=new D(e);return(await this.call([n],t,r)).content}}function G(u){return{name:u.name,description:u.description,parameters:F.zodToJsonSchema(u.schema)}}function k(u){switch(u){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";default:throw new Error(`Unknown message type: ${u}`)}}function Q(u){switch(u.role){case"user":return new D(u.content||"");case"assistant":return new Y(u.content||"",{function_call:u.function_call});case"system":return new V(u.content||"");default:return new q(u.content||"",u.role??"unknown")}}class X extends ${get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","promptIndex"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,t){if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=(e==null?void 0:e.openAIApiKey)??d("OPENAI_API_KEY"),this.azureOpenAIApiKey=(e==null?void 0:e.azureOpenAIApiKey)??d("AZURE_OPENAI_API_KEY"),!this.azureOpenAIApiKey&&!this.openAIApiKey)throw new Error("OpenAI or Azure OpenAI API key not found");if(this.azureOpenAIApiInstanceName=(e==null?void 0:e.azureOpenAIApiInstanceName)??d("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=(e==null?void 0:e.azureOpenAIApiDeploymentName)??d("AZURE_OPENAI_API_DEPLOYMENT_NAME"),this.azureOpenAIApiVersion=(e==null?void 0:e.azureOpenAIApiVersion)??d("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=(e==null?void 0:e.azureOpenAIBasePath)??d("AZURE_OPENAI_BASE_PATH"),this.modelName=(e==null?void 0:e.modelName)??this.modelName,this.modelKwargs=(e==null?void 0:e.modelKwargs)??{},this.timeout=e==null?void 0:e.timeout,this.temperature=(e==null?void 0:e.temperature)??this.temperature,this.topP=(e==null?void 0:e.topP)??this.topP,this.frequencyPenalty=(e==null?void 0:e.frequencyPenalty)??this.frequencyPenalty,this.presencePenalty=(e==null?void 0:e.presencePenalty)??this.presencePenalty,this.maxTokens=e==null?void 0:e.maxTokens,this.n=(e==null?void 0:e.n)??this.n,this.logitBias=e==null?void 0:e.logitBias,this.stop=e==null?void 0:e.stop,this.streaming=(e==null?void 0:e.streaming)??!1,this.azureOpenAIApiKey){if(!this.azureOpenAIApiInstanceName)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found")}this.clientConfig={apiKey:this.openAIApiKey,...t,...e==null?void 0:e.configuration}}invocationParams(e){return{model:this.modelName,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:this.maxTokens===-1?void 0:this.maxTokens,n:this.n,logit_bias:this.logitBias,stop:(e==null?void 0:e.stop)??this.stop,stream:this.streaming,functions:(e==null?void 0:e.functions)??(e!=null&&e.tools?e==null?void 0:e.tools.map(G):void 0),function_call:e==null?void 0:e.function_call,...this.modelKwargs}}_identifyingParams(){return{model_name:this.modelName,...this.invocationParams(),...this.clientConfig}}identifyingParams(){return this._identifyingParams()}async _generate(e,t,r){var y;const n={},i=this.invocationParams(t),c=e.map(p=>({role:k(p._getType()),content:p.content,name:p.name,function_call:p.additional_kwargs.function_call})),_=i.stream?await new Promise((p,l)=>{let m,A=!1,P=!1;this.completionWithRetry({...i,messages:c},{signal:t==null?void 0:t.signal,...t==null?void 0:t.options,adapter:R,responseType:"stream",onmessage:b=>{var w,v,T,N,z,E,K,j,C,L;if(((v=(w=b.data)==null?void 0:w.trim)==null?void 0:v.call(w))==="[DONE]"){if(P||A)return;P=!0,p(m)}else{const f=JSON.parse(b.data);if(f!=null&&f.error){if(A)return;A=!0,l(f.error);return}const O=f;m||(m={id:O.id,object:O.object,created:O.created,model:O.model,choices:[]});for(const h of O.choices??[])if(h!=null){let g=m.choices.find(U=>U.index===h.index);g||(g={index:h.index,finish_reason:h.finish_reason??void 0},m.choices[h.index]=g),g.message||(g.message={role:(T=h.delta)==null?void 0:T.role,content:""}),h.delta.function_call&&!g.message.function_call&&(g.message.function_call={name:"",arguments:""}),g.message.content+=((N=h.delta)==null?void 0:N.content)??"",g.message.function_call&&(g.message.function_call.name+=((E=(z=h.delta)==null?void 0:z.function_call)==null?void 0:E.name)??"",g.message.function_call.arguments+=((j=(K=h.delta)==null?void 0:K.function_call)==null?void 0:j.arguments)??""),r==null||r.handleLLMNewToken(((C=h.delta)==null?void 0:C.content)??"",{prompt:t.promptIndex??0,completion:h.index})}!P&&!A&&((L=O.choices)!=null&&L.every(h=>h.finish_reason!=null))&&(P=!0,p(m))}}}).catch(b=>{A||(A=!0,l(b))})}):await this.completionWithRetry({...i,messages:c},{signal:t==null?void 0:t.signal,...t==null?void 0:t.options}),{completion_tokens:s,prompt_tokens:I,total_tokens:a}=_.usage??{};s&&(n.completionTokens=(n.completionTokens??0)+s),I&&(n.promptTokens=(n.promptTokens??0)+I),a&&(n.totalTokens=(n.totalTokens??0)+a);const o=[];for(const p of _.choices){const l=((y=p.message)==null?void 0:y.content)??"";o.push({text:l,message:Q(p.message??{role:"assistant"})})}return{generations:o,llmOutput:{tokenUsage:n}}}async getNumTokensFromMessages(e){let t=0,r=0,n=0;M(this.modelName)==="gpt-3.5-turbo"?(r=4,n=-1):M(this.modelName).startsWith("gpt-4")&&(r=3,n=1);const i=await Promise.all(e.map(async c=>{const _=await this.getNumTokens(c.content),s=await this.getNumTokens(k(c._getType())),I=c.name!==void 0?n+await this.getNumTokens(c.name):0,a=_+r+s+I;return t+=a,a}));return t+=3,{totalCount:t,countPerMessage:i}}async completionWithRetry(e,t){if(!this.client){const n={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,basePath:this.clientConfig.basePath},i=Z(n),c=new x.Configuration({...this.clientConfig,basePath:i,baseOptions:{timeout:this.timeout,...this.clientConfig.baseOptions}});this.client=new x.OpenAIApi(c)}const r={adapter:S()?void 0:R,...this.clientConfig.baseOptions,...t};return this.azureOpenAIApiKey&&(r.headers={"api-key":this.azureOpenAIApiKey,...r.headers},r.params={"api-version":this.azureOpenAIApiVersion,...r.params}),this.caller.call(this.client.createChatCompletion.bind(this.client),e,r).then(n=>n.data)}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((t,r)=>(r&&r.tokenUsage&&(t.tokenUsage.completionTokens+=r.tokenUsage.completionTokens??0,t.tokenUsage.promptTokens+=r.tokenUsage.promptTokens??0,t.tokenUsage.totalTokens+=r.tokenUsage.totalTokens??0),t),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}}class oe extends X{constructor(e){var t;super(e),Object.defineProperty(this,"promptLayerApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"plTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnPromptLayerId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.promptLayerApiKey=(e==null?void 0:e.promptLayerApiKey)??(typeof process<"u"?(t=process.env)==null?void 0:t.PROMPTLAYER_API_KEY:void 0),this.plTags=(e==null?void 0:e.plTags)??[],this.returnPromptLayerId=(e==null?void 0:e.returnPromptLayerId)??!1}async _generate(e,t,r){const n=Date.now();let i;Array.isArray(t)?i={stop:t}:t!=null&&t.timeout&&!t.signal?i={...t,signal:AbortSignal.timeout(t.timeout)}:i=t??{};const c=await super._generate(e,i,r),_=Date.now(),s=a=>{let o;if(a._getType()==="human")o={role:"user",content:a.content};else if(a._getType()==="ai")o={role:"assistant",content:a.content};else if(a._getType()==="function")o={role:"assistant",content:a.content};else if(a._getType()==="system")o={role:"system",content:a.content};else if(a._getType()==="generic")o={role:a.role,content:a.content};else throw new Error(`Got unknown type ${a}`);return o},I=(a,o)=>{const y={...this.invocationParams(),model:this.modelName};if(o!=null&&o.stop&&Object.keys(y).includes("stop"))throw new Error("`stop` found in both the input and default params.");return a.map(l=>s(l))};for(let a=0;a<c.generations.length;a+=1){const o=c.generations[a],y=I(e,i);let p;const l=[{content:o.text,role:k(o.message._getType())}],m=await H(this.caller,"langchain.PromptLayerChatOpenAI",y,this._identifyingParams(),this.plTags,l,n,_,this.promptLayerApiKey);this.returnPromptLayerId===!0&&(m.success===!0&&(p=m.request_id),(!o.generationInfo||typeof o.generationInfo!="object")&&(o.generationInfo={}),o.generationInfo.promptLayerRequestId=p)}return c}}export{X as ChatOpenAI,oe as PromptLayerChatOpenAI};
